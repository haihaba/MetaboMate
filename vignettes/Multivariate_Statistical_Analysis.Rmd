---
title: "NMR-based Metabolic Profiling with R - Multivariate Statistical Analysis"
author: "Torben Kimhofer"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette documents a typical multivariate statistical analysis workflow for NMR-based metabolic profilig using the *MetaboMate* R package. Example data represent Proton NMR spectra of murine urine samples collected pre and post bariatric surgery^[Li, Jia V., *et al.* (2011) Metaboilc surgery profoundly influences gut microbial-host mtaboilc cross-talk. *Gut* 60.9, 1214-1223.]. Data have been pre-processed with *MetboMate* functions including spectral calibration, excision of chemical shift regions representing noise or unwanted signals and normalisation to account for different sample dilutions. Please see *Data Preprocessing* vignette for further information on data pre-processing.

## Prerequisites
For multivariate analysis the following variables should be in the R workspace:

* *X.pqn* = preprocessed NMR data matrix, with rows representing spectra and columns spectral features (ppm variables)
* *ppm* = ppm vector, its length equals to the columns of X.pqn
* *meta* = spectrometer metadata (this is not essential but useful for this tutorial)

I also recommend to install RStudio. RStudio is an open-source integrated development environment for R, which includes a code editor that highlights syntax, enables quick and easy access to help pages, improves workspace management and offers various tools for plotting, history and debugging. Simply put, it makes working with R a lot more efficient.

## Visual inspection of the NMR data
Let's start with a visual inspection of the pre-processed NMR spectra using the **matspec()** function:
```{r, fig.show='hold', fig.width = 7.2, fig.height = 4}
library(MetaboMate)
data(bariatric)
#matspec(ppm, X.pqn, shift = range(ppm))
```

Specra are nicely overlayed over a range of 0.5 to 9.5 ppm.

## Unsupervised Multivariate Analysis
Expoloratory data analysis is usually the first statistical analysis step in metabolic phenotyping. Traditionally, Pricipal Component Analysis (PCA) is used for this step as this projection method summarises the main sources of systematic variation (or latent factors, latent in the sense of unobserved) in so called principal components. Thefore, PCA reduces data dimensionality and can give important insights into the data structure.

Performing a PCA and plotting the PCA scores can be achieved with the **pca()** and **plotscores** functions, respectively:

```{r, fig.show='hold', fig.width = 7.2, fig.height = 4}
#pca.model=pca(X=X.pqn, pc=2, scale='UV', center=T)
#slotNames(pca.model)
```

The input arguments of the **pca** function comprise the pre-processed NMR matris (*X.pqn*), information on how many prinicipal components should be fitted (*pc*) and centering and scaling parameters, in this case unit variance (UV) scaling and mean centering. The result is a *PCA_Metabomate* object, whith different slots contains PCA model results, such as PCA scores (*t*) and loadings (*p*).

Plotting PCA scores can be achieved with the **plotscores()** function, which arguments are a *PCA_Metabomate* object (*model*), the desired plot dimensions (*pc*) and colouring, labelling and point shape information as a list with one to three elements, depending if label and point shapes should be specified (*an*). Here's an example:
```{r, fig.show='hold', fig.width = 5, fig.height = 4}
#plotscores(model=pca.model, pc=c(1,2), an=list(DilF=log10(dilF.pqn)), title='PCA - Scores plot')
```
The scatterplot above shows PCA scores of principal components 1 and 2 as abcissa/x-axis and ordinate/y-axis, respectively. Every point represents a sample which is coloured according to the sample dilution factor (calculated in a pre-processing step). The ellipse is called Hotelling's T^2^ and represents a multivariate generalisation of a 95% confidence interval, flagging outlier spectra. The axis label values in parenthesis describe the amount of variation each component describes, also termed R^2^.

## Supervised Multivariate Analysis
OPLS-DA or PCA-R

```{r, fig.show='hold', fig.width = 7.2, fig.height = 4}
#opls.model=opls(X=X.pqn,Y=dilF.pqn)
#plotscores(opls.model, pc=c(1,2), an=list(DilF=dilF.pqn), title='OPLS - Scores plot', cv.scores = F)
#plotload(opls.model, X.pqn, ppm, type='Backscaled', title = 'OPLS: Backscaled Loadings')
#distanceX=dmodx(opls.model, plot=T)
```

Further plotting options

### Metabolite Identification
```{r, fig.show='hold', fig.width = 7.2, fig.height = 4}
#specload(opls.model, X.pqn, ppm, shift=c(1,1.3), an=list(dilF.pqn<1 ), type='Backscaled')

```

## Vignette Info

This vignette is not completed. Missing sections: Metabolite Identification, Clustering, several explanations (although man pages should be all available).


